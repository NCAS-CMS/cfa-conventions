
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3. The CFA-netCDF conventions</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="" href="index.html" />
    <link rel="next" title="4. CFA-netCDF properties" href="cfa_attributes.html" />
    <link rel="prev" title="2. The CFA framework" href="framework.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cfa_attributes.html" title="4. CFA-netCDF properties"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="framework.html" title="2. The CFA framework"
             accesskey="P">previous</a> |</li>
  <li><a href="index.html">CFA</a>
      <select onchange="location = this.options[this.selectedIndex].value;">
  <option value="../0.4/index.html"selected>0.4
  <option value="../0.3/index.html">0.3
  <option value="../0.2.2/index.html">0.2.2
  <option value="../0.2.1/index.html">0.2.1
  <option value="../0.2/index.html">0.2
  <option value="../0.1/index.html">0.1
  </select>
  </li>

  
        <li><a href="index.html"></a> &raquo;</li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="the-cfa-netcdf-conventions">
<span id="cfa-netcdf-conventions"></span><h1>3. The CFA-netCDF conventions<a class="headerlink" href="#the-cfa-netcdf-conventions" title="Permalink to this headline">¶</a></h1>
<p>The CFA-netCDF conventions describe the efficient netCDF file storage
of CF fields with master data arrays which have been aggregated within
the <a class="reference internal" href="framework.html#framework"><em>CFA framework</em></a>.</p>
<div class="section" id="storing-the-master-data-array-parameters-in-a-string">
<h2>3.1. Storing the master data array parameters in a string<a class="headerlink" href="#storing-the-master-data-array-parameters-in-a-string" title="Permalink to this headline">¶</a></h2>
<p>Since the <a class="reference internal" href="framework.html#cfa-framework-parameters"><em>parameters</em></a> which
completely describe a master data array may each be cast as one of a
set of particular basic types, these parameters may be easily encoded
in a <a class="reference external" href="http://www.json.org">JSON (JavaScript Object Notation) string</a>
for simple inclusion in a netCDF file.</p>
<p>JSON is a lightweight data-interchange format which is easy for humans
to read and write and easy for machines to parse and generate. There
are JSON encoders and decoders for every reasonable language. See the
<a class="reference external" href="http://en.wikipedia.org/wiki/JSON">JSON Wikipedia article</a> for some
good examples of JSON strings.</p>
<p>The basic types recognised by JSON are (with JSON encoded examples):</p>
<ul class="simple">
<li>string (double-quoted Unicode, with backslash escaping: <tt class="docutils literal"><span class="pre">&quot;foo&quot;</span></tt>,
<tt class="docutils literal"><span class="pre">&quot;&quot;</span></tt>)</li>
<li>number (<tt class="docutils literal"><span class="pre">3.14159</span></tt>, <tt class="docutils literal"><span class="pre">0</span></tt>)</li>
<li>boolean (true or false: <tt class="docutils literal"><span class="pre">true</span></tt>, <tt class="docutils literal"><span class="pre">false</span></tt>)</li>
<li>null (empty: <tt class="docutils literal"><span class="pre">null</span></tt>)</li>
<li>Array (an ordered, comma-separated sequence of values enclosed in
square brackets; the values do not need to be of the same type:
<tt class="docutils literal"><span class="pre">[1,</span> <span class="pre">&quot;a&quot;,</span> <span class="pre">[2,</span> <span class="pre">null,</span> <span class="pre">{&quot;x&quot;:</span> <span class="pre">false}]]</span></tt>)</li>
<li>Object (an unordered, comma-separated collection of key:value pairs
enclosed in curly braces, with the &#8216;:&#8217; character separating the key
and the value; the keys must be strings and should be distinct from
each other: <tt class="docutils literal"><span class="pre">{&quot;x&quot;:</span> <span class="pre">[4,</span> <span class="pre">[true,</span> <span class="pre">null]],</span> <span class="pre">&quot;y&quot;:</span> <span class="pre">2.71828}</span></tt>)</li>
</ul>
<p>It clear that, with the exception of the partition&#8217;s <a class="reference internal" href="framework.html#frame-subarray"><em>subarray</em></a> parameter, each of the values of the parameters
which describe a master data array is one or a combination of these
basic types. For example, the <a class="reference internal" href="framework.html#frame-pmshape"><em>pmshape</em></a> parameter
is a list of numbers.</p>
<p>The same is actually true for the partition&#8217;s <a class="reference internal" href="framework.html#frame-subarray"><em>subarray</em></a> parameter, although it is not so immediately
obvious. The issue is that it may be a reference to section of a file
or to a multidimensional array in memory. However, in the latter case
the sub-array must be written to a file in order to be stored, so this
reduces to the former case. A file reference is easily encapsulated by
a collection of the basic types. For example, if the reference is to a
netCDF file variable then all that is required are the file name (a
string), the name of the netCDF variable containing the sub-array (a
string) and its shape (a list of numbers) <a class="footnote-reference" href="#f1" id="id1">[1]</a>.</p>
<p>Thus, for storage purposes, all of the master data array parameters
may be encoded in a single JSON string.</p>
<p>See the complete description of <a class="reference internal" href="cfa_attributes.html#cfa-ref"><em>CFA-netCDF attributes</em></a>
for details on how each master data array parameter is encoded.</p>
</div>
<div class="section" id="creating-a-netcdf-variable-for-the-master-data-array">
<span id="scalar-variable"></span><h2>3.2. Creating a netCDF variable for the master data array<a class="headerlink" href="#creating-a-netcdf-variable-for-the-master-data-array" title="Permalink to this headline">¶</a></h2>
<p>A multidimensional master data array may be stored in a <strong>scalar
netCDF variable</strong> with the same <strong>data type</strong> as its master array,
whose attributes include the JSON encoded strings of the master data
array parameters. When read, this scalar array variable may then be
converted to a multidimensional array variable after the parameters
have been decoded. Note that the datum of this scalar netCDF variable
is ignored and need not be set.</p>
<p id="cfa-variable">Such a variable is called a <strong>CFA variable</strong> and a file storing CFA
variables is called a <strong>CFA-netCDF file</strong> and should include both &#8216;CF&#8217;
and &#8216;CFA&#8217; in its global <tt class="docutils literal"><span class="pre">conventions</span></tt> attribute. A CFA-netCDF file
may contain a mixture of CFA variables and normal netCDF variables, or
even no CFA variables at all. In the latter case, the CFA-netCDF file
is also a CF-netCDF file.</p>
<p id="cfa-private-variable">For partitions whose <a class="reference internal" href="framework.html#frame-subarray"><em>subarray</em></a> parameter refers
to a sub-array in memory, that sub-array is written to the CFA-netCDF file
itself as a <strong>CFA private variable</strong>. This is a normal netCDF
variable marked as containing the sub-array for a partition of one or
more CFA variables and should not be interpreted otherwise according
to the CF conventions. As this sub-array now exists in a netCDF file,
the relevant CFA variables may refer to this sub-array as for any
netCDF variable, i.e. by specifying the netCDF file name <a class="footnote-reference" href="#f2" id="id2">[2]</a>, the
netCDF variable name and its shape. See <a class="reference internal" href="#example4"><em>example 4</em></a>.</p>
</div>
<div class="section" id="advantages-of-netcdf">
<span id="id3"></span><h2>3.3. Advantages of netCDF<a class="headerlink" href="#advantages-of-netcdf" title="Permalink to this headline">¶</a></h2>
<p>File storage of an aggregated field stored does not need to use netCDF
format (for example, plain text <a class="reference external" href="http://en.wikipedia.org/wiki/XML">XML</a> or <a class="reference external" href="http://www.unidata.ucar.edu/software/netcdf/docs/netcdf/CDL-Syntax.html">CDL</a>
format files would be sufficient) but there some reasons why it is
desirable:</p>
<ul class="simple">
<li>Nearly all of the discovery metadata in a CFA-netCDF file is easily
retrievable with standard, unmodified netCDF libraries. The only
exception is the ordered list netCDF dimension names of a CFA
variable, and to ameliorate any difficulties associated with this,
these are stored in their own netCDF property for easy access (see
the <a class="reference internal" href="cfa_attributes.html#cfa-dimensions"><em>cfa_dimensions</em></a> property).</li>
<li>A plain text CDL representation of a CFA-netCDF file is trivial to
produce with the ncdump utility.</li>
<li>An important part of the CFA conventions is the ability to mix,
within the same CFA-netCDF file, normal CF-netCDF variables
(possibly with very large data arrays) with CFA variables (which may
contain references to CFA private variables, possibly with very
large data arrays, in the same file), so a binary format is
desirable to keep the file size to a minimum.</li>
<li>A CFA variable may contain any CF property such as cell methods,
flags, ancillary variables, coordinates, formula_terms, <em>etc.</em> By
using a netCDF file, there is no need to invent new encodings for
complex field properties which have already been standardized for
netCDF variables by the CF conventions.</li>
</ul>
</div>
<div class="section" id="recommended-usage">
<h2>3.4. Recommended usage<a class="headerlink" href="#recommended-usage" title="Permalink to this headline">¶</a></h2>
<p>CFA-netCDF files should have the file name extension &#8221;.nca&#8221;.</p>
<p>It is recommended, though not necessary to write the following types
of variable as normal netCDF variables:</p>
<ul class="simple">
<li>One dimensional coordinates and their bounds (to facilitate
discovery).</li>
<li>Master data arrays with only one partition whose data array would
otherwise be written to a CFA-netCDF file as a CFA private variable (to
avoid unnecessary obfuscation).</li>
</ul>
</div>
<div class="section" id="examples">
<h2>3.5. Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>The following example files are described by their CDL representation.</p>
<div class="section" id="example-3">
<h3>3.5.1. Example 3<a class="headerlink" href="#example-3" title="Permalink to this headline">¶</a></h3>
<p>A simple CFA-netCDF file:</p>
<div class="highlight-python"><pre>netcdf temperature.nca {
dimensions:
       time = 48 ;
       lat = 64 ;
       lon = 128 ;
variable:

    double time(time) ;
            time:long_name = "time" ;
            time:units = "days since 0000-1-1" ;
    double lat(lat) ;
            lat:units = "degrees_north" ;
            lat:standard_name = "latitude" ;
    double lon(lon) ;
            lon:units = "degrees_east" ;
            lon:standard_name = "longitude" ;
    float tas ;
            tas:standard_name = "air_temperature" ;
            tas:units = "K" ;
            tas:cf_role = "cfa_variable" ;
            tas:cfa_dimensions = "time lat lon" ;
            tas:cfa_array = '{"pmshape": [2],
                              "pmdimensions": ["time"],
                              "Partitions": [{"index": [0],
                                              "data": {"file": "/home/david/test1.nc",
                                                       "shape": [12, 64, 128],
                                                       "ncvar": "tas"
                                                      },
                                              "location": [[0, 12], [0, 64], [0, 128]],
                                              "format": "netCDF"
                                             },
                                             {"index": [1],
                                              "data": {"file": "/home/david/test2.nc",
                                                       "shape": [36, 64, 128],
                                                       "ncvar": "tas2"
                                                      },
                                              "location": [[12, 48], [0, 64], [0, 128]],
                                              "format": "netCDF"
                                             }
                                            ]
                             }' ;

// global attributes:
               :Conventions = "CF-1.5 CFA" ;
data:

 time = 164569, 164599.5, 164630.5, 164660, 164689.5, 164720, 164750.5,
       // etcetera.

 lat = -87.8638000488281, -85.0965270996094, -82.3129119873047,
       // etcetera.

 lon = 0, 2.8125, 5.625, 8.4375, 11.25, 14.0625, 16.875, 19.6875, 22.5,
       // etcetera.</pre>
</div>
<p>Points to note:</p>
<ul class="simple">
<li>The file specifies two conventions.</li>
<li>The file contains one CFA variable (<tt class="docutils literal"><span class="pre">tas</span></tt>) and three normal
variables (<tt class="docutils literal"><span class="pre">time</span></tt>, <tt class="docutils literal"><span class="pre">lat</span></tt> and <tt class="docutils literal"><span class="pre">lon</span></tt>).</li>
<li>The CFA variable stores the master data array&#8217;s dimensions in a
separate attribute (<tt class="docutils literal"><span class="pre">cfa_dimensions</span></tt>) to facilitate reconstruction
of a multidimensional variable without having to decode the
<tt class="docutils literal"><span class="pre">cfa_array</span></tt> string.</li>
<li>The <tt class="docutils literal"><span class="pre">cfa_array</span></tt> string has been split over many lines for enhanced
readability. New lines are permitted in JSON strings.</li>
<li>The CFA variable defines its data type and units in the normal
manner, so that these parameters of the master array may be omitted
from the <tt class="docutils literal"><span class="pre">cfa_array</span></tt> attribute.</li>
<li>The CFA variable may have any CF-netCDF attributes, with no
restrictions.</li>
<li>Partition parameters which are the same as their master array may be
omitted.</li>
</ul>
</div>
<div class="section" id="example-4">
<span id="example4"></span><h3>3.5.2. Example 4<a class="headerlink" href="#example-4" title="Permalink to this headline">¶</a></h3>
<p>Storing a master data array with an in-memory partition data array:</p>
<div class="highlight-python"><pre>netcdf temperature2.nca {
dimensions:
        time = 48 ;
        lat = 64 ;
        lon = 128 ;
        cfa12 = 12 ;
        cfa64 = 64 ;
        cfa128 = 128 ;
variable:
        double time(time) ;
                time:long_name = "time" ;
                time:units = "days since 0000-1-1" ;
        double lat(lat) ;
                lat:units = "degrees_north" ;
                lat:standard_name = "latitude" ;
        double lon(lon) ;
                lon:units = "degrees_east" ;
                lon:standard_name = "longitude" ;
        float tas ;
                tas:standard_name = "air_temperature" ;
                tas:units = "K" ;
                tas:cf_role = "cfa_variable" ;
                tas:cfa_dimensions = "time lat lon" ;
                tas:cfa_array = '{"pmshape": [2],
                                  "pmdimensions": ["time"],
                                  "Partitions": [{"index": [0],
                                                  "punits" : "K @ 273.15",
                                                  "pdimensions": ["lon", "time", lat"],
                                                  "flip": ["time"],
                                                  "data": {"shape": [128, 12, 64],
                                                           "ncvar": "cfa_45sdf83745"
                                                          },
                                                  "location": [[0, 12], [0, 64], [0, 128]],
                                                  "format": "netCDF"
                                                 },
                                                 {"index": [1],
                                                  "data": {"file": "/home/david/test2.nc",
                                                           "shape": [36, 64, 128],
                                                           "ncvar": "tas2"
                                                          },
                                                  "location": [[12, 48], [0, 64], [0, 128]],
                                                  "format": "netCDF"
                                                 }
                                                ]
                                 }' ;
        float cfa_45sdf83745(cfa128, cfa12, cfa64) ;
                cfa_45sdf83745:cf_role = "cfa_private" ;


// global attributes:
                :Conventions = "CF-1.5 CFA" ;
data:

 time = 164569, 164599.5, 164630.5, 164660, 164689.5, 164720, 164750.5,
       // etcetera.

 lat = -87.8638000488281, -85.0965270996094, -82.3129119873047,
       // etcetera.

 lon = 0, 2.8125, 5.625, 8.4375, 11.25, 14.0625, 16.875, 19.6875, 22.5,
       // etcetera.

 cfa_45sdf83745 = -4.5, 3.5, 23.6, -4.45, 13.5, 13.6,
       // etcetera.</pre>
</div>
<p>Points to note:</p>
<ul class="simple">
<li>The in-memory partition data array has been written to the file with
an automatically generated variable name (<tt class="docutils literal"><span class="pre">cfa_45sdf83745</span></tt>), which
has an attribute <tt class="docutils literal"><span class="pre">cfa_private</span></tt> to mark it as a private variable
according to the CFA convention.</li>
<li>The in-memory array had different units and dimension order relative
to the master array.</li>
<li>The time dimension of the in-memory array runs in the opposite
direction to the time dimension of the master data array, but the
other dimensions run in the same sense as the master array.</li>
<li>The CFA private variable has dimensions which are only used by it
and other CFA private variables.</li>
</ul>
<hr class="docutils" />
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>The shape is required since the sub-array may omit (contain)
size one dimensions which are (are not) present in the master
data array. Also, a multi-character string array in memory
may be different to the shape of the array stored in a netCDF
file, which may be stored as a character array with an extra
trailing dimension.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>In this case, though, the file name may be omitted, in which
case the name of the CFA-netCDF file is assumed. See the
<a class="reference internal" href="cfa_attributes.html#file"><em>file</em></a> attribute.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3. The CFA-netCDF conventions</a><ul>
<li><a class="reference internal" href="#storing-the-master-data-array-parameters-in-a-string">3.1. Storing the master data array parameters in a string</a></li>
<li><a class="reference internal" href="#creating-a-netcdf-variable-for-the-master-data-array">3.2. Creating a netCDF variable for the master data array</a></li>
<li><a class="reference internal" href="#advantages-of-netcdf">3.3. Advantages of netCDF</a></li>
<li><a class="reference internal" href="#recommended-usage">3.4. Recommended usage</a></li>
<li><a class="reference internal" href="#examples">3.5. Examples</a><ul>
<li><a class="reference internal" href="#example-3">3.5.1. Example 3</a></li>
<li><a class="reference internal" href="#example-4">3.5.2. Example 4</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="framework.html"
                        title="previous chapter">2. The CFA framework</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="cfa_attributes.html"
                        title="next chapter">4. CFA-netCDF properties</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/cfa.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search term.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="cfa_attributes.html" title="4. CFA-netCDF properties"
             >next</a> |</li>
        <li class="right" >
          <a href="framework.html" title="2. The CFA framework"
             >previous</a> |</li>
  <li><a href="index.html">CFA</a>
      <select onchange="location = this.options[this.selectedIndex].value;">
  <option value="../0.4/index.html"selected>0.4
  <option value="../0.3/index.html">0.3
  <option value="../0.2.2/index.html">0.2.2
  <option value="../0.2.1/index.html">0.2.1
  <option value="../0.2/index.html">0.2
  <option value="../0.1/index.html">0.1
  </select>
  </li>

  
        <li><a href="index.html"></a> &raquo;</li>
 
      </ul>
    </div>
    <div class="footer">
      Last updated on Feb 27, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>