<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3. The NCA convention</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="" href="index.html" />
    <link rel="next" title="4. A complete description of netCDF NCA attributes describing the aggregated data" href="nca_attributes.html" />
    <link rel="prev" title="2. A conceptual framework for the in-memory storage of aggregated arrays" href="framework.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="nca_attributes.html" title="4. A complete description of netCDF NCA attributes describing the aggregated data"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="framework.html" title="2. A conceptual framework for the in-memory storage of aggregated arrays"
             accesskey="P">previous</a> |</li>
  <li><a href="index.html">CFA</a>
      <select onchange="location = this.options[this.selectedIndex].value;">
  <option value="../0.4/index.html">0.4
  <option value="../0.3/index.html">0.3
  <option value="../0.2.2/index.html">0.2.2
  <option value="../0.2.1/index.html">0.2.1
  <option value="../0.2/index.html"selected>0.2
  <option value="../0.1/index.html">0.1
  </select>
  </li>

  
        <li><a href="index.html"></a> &raquo;</li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="the-nca-convention">
<h1>3. The NCA convention<a class="headerlink" href="#the-nca-convention" title="Permalink to this headline">¶</a></h1>
<p><strong>A proposal for the efficient netCDF file storage of aggregated data
arrays</strong></p>
<div class="section" id="storing-the-aggregated-data-array-parameters-in-a-string">
<h2>3.1. Storing the aggregated data array parameters in a string<a class="headerlink" href="#storing-the-aggregated-data-array-parameters-in-a-string" title="Permalink to this headline">¶</a></h2>
<p>Since the parameters which completely describe an aggregated data
array may each be cast as one a set of particular basic types, then
these parameters may be easily encoded in a <a class="reference external" href="http://www.json.org">JSON (JavaScript Object
Notation)</a> string for simple inclusion in a
netCDF file.</p>
<p>JSON is a lightweight data-interchange format which is easy for humans
to read and write and easy for machines to parse and generate. There
are JSON encoders and decoders for every reasonable language. See the
<a class="reference external" href="http://en.wikipedia.org/wiki/JSON">JSON Wikipedia article</a> for some
good examples of JSON strings.</p>
<p>These basic types recognised by JSON are (with JSON encoded examples):</p>
<ul class="simple">
<li>string (<tt class="docutils literal"><span class="pre">'foo'</span></tt>, <tt class="docutils literal"><span class="pre">''</span></tt>)</li>
<li>number (<tt class="docutils literal"><span class="pre">3.14159</span></tt>, <tt class="docutils literal"><span class="pre">0</span></tt>)</li>
<li>boolean (<tt class="docutils literal"><span class="pre">true</span></tt>, <tt class="docutils literal"><span class="pre">false</span></tt>)</li>
<li>Undefined (<tt class="docutils literal"><span class="pre">null</span></tt>)</li>
<li>list of any of the basic types (<tt class="docutils literal"><span class="pre">[1,</span> <span class="pre">'a',</span> <span class="pre">['2,</span> <span class="pre">null,</span> <span class="pre">{'x':</span> <span class="pre">false}]]</span></tt>)</li>
<li>associative array with strings for keys and any of the basic types
for values (<tt class="docutils literal"><span class="pre">{'x':</span> <span class="pre">[4,</span> <span class="pre">[true,</span> <span class="pre">null]],</span> <span class="pre">'y':</span> <span class="pre">2.71828}</span></tt>)</li>
</ul>
<p>With the exception of partition&#8217;s <a class="reference internal" href="framework.html#frame-data"><em>data</em></a> parameter,
it is clear that each of the values of the parameters which describe
an aggregated data array is one of these basic types. For example, the
<a class="reference internal" href="framework.html#frame-pmshape"><em>pmshape</em></a> parameter is a list of numbers.</p>
<p>The partition&#8217;s <a class="reference internal" href="framework.html#frame-data"><em>data</em></a> parameter may also be
described by these basic types, but is more complicated. It will be
one of:</p>
<ol class="arabic simple">
<li>A reference to section of a file.</li>
<li>A reference to an actual array in memory.</li>
</ol>
<p>In case 1 there is no problem, as it will always be possible to
encapsulate the reference with a collection of these basic types. For
example, if the reference is to a netCDF file variable then all that
is required are its filename (a string), the name of the netCDF
variable containing the sub-array (a string) and its shape (a list of
numbers) <a class="footnote-reference" href="#f1" id="id1">[1]</a>.</p>
<p>In case 2, the sub-array in memory gets stored in a netCDF file
variable, and so case 1 applies. See the notes on <a class="reference internal" href="#private-nca-variable"><em>private NCA
variables</em></a> for details.</p>
</div>
<div class="section" id="creating-a-netcdf-variable-for-the-aggregated-data-array">
<span id="scalar-variable"></span><h2>3.2. Creating a netCDF variable for the aggregated data array<a class="headerlink" href="#creating-a-netcdf-variable-for-the-aggregated-data-array" title="Permalink to this headline">¶</a></h2>
<p>A multidimensional aggregated data array may be stored in a <strong>scalar
netCDF variable</strong> with the same <strong>data type</strong> as its master array, one
of whose attributes is the JSON encoded string of the aggregated data
array parameters. When read, this scalar array variable may then be
converted to a multidimensional array variable after the parameters
have been decoded. Note that the scalar netCDF variable normal netCDF
datum is ignored and need not be set.</p>
<p id="nca-variable">Such a variable is called an <strong>NCA variable</strong> (netCDF aggregate
variable) and a file storing NCA variables is called an <strong>NCA file</strong>
(netCDF aggregate file) and should include both &#8216;CF&#8217; and &#8216;NCA&#8217; in its
global <tt class="docutils literal"><span class="pre">conventions</span></tt> attribute.</p>
<p id="private-nca-variable">For partitions whose <a class="reference internal" href="framework.html#frame-data"><em>data</em></a> parameter refers to a
sub-array in memory, that array must be written to the NCA file as a
<strong>private NCA variable</strong>. This is a normal netCDF variable marked as
containing the sub-array for a partition of one or more NCA
variables. As this sub-array now exists in a netCDF file (the NCA file
itself), the relevant NCA variables may refer to this sub-array as for
any netCDF variable, i.e. by specifying the netCDF file name <a class="footnote-reference" href="#f2" id="id2">[2]</a>,
the netCDF variable name and its shape. See <a class="reference internal" href="#example3"><em>example 3</em></a>.</p>
<div class="section" id="advantages">
<h3>3.2.1. Advantages<a class="headerlink" href="#advantages" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>NCA files are CF compliant.</li>
<li>Variables within an NCA file may be a mixture of normal,
multidimensional array variables and NCA variables.</li>
<li>Much, if not all, of the discovery metadata in an NCA is independent
of the aggregated data array convention and so is accessible to all
netCDF readers.</li>
<li>Changes to the elements of the aggregated data array may be stored.</li>
<li>An NCA variable may have any attributes attached to it.</li>
<li>NCA encoded parameters may be succinct, as there are clear rules on
taking default values for partitions.</li>
</ul>
</div>
<div class="section" id="disadvantages">
<h3>3.2.2. Disadvantages<a class="headerlink" href="#disadvantages" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Software which creates and reads NCA files in their entirety needs
to be able to cope with aggregated data arrays. <a class="reference external" href="http://cfpython.bitbucket.org">cf-python</a> can do this.</li>
</ul>
</div>
<div class="section" id="comparison-with-ncml-aggregation">
<span id="ncml"></span><h3>3.2.3. Comparison with NcML aggregation<a class="headerlink" href="#comparison-with-ncml-aggregation" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.unidata.ucar.edu/software/netcdf/ncml/v2.2/Aggregation.html">NetCDF Markup Language (NcML) aggregation</a>
doesn&#8217;t allow:</p>
<ul class="simple">
<li>Simultaneous aggregation across arbitrarily positioned dimensions.</li>
<li>Aggregation of arbitrary parts of arrays.</li>
<li>Aggregation arrays stored in arbitrary formats (in-memory, netCDF,
PP, <em>etc.</em>).</li>
</ul>
<hr class="docutils" />
<p><strong>Example 2: A simple NCA file</strong>:</p>
<div class="highlight-python"><pre>netcdf temperature.nca {
dimensions:
       time = 48 ;
       lat = 64 ;
       lon = 128 ;
variable:

    double time(time) ;
            time:long_name = "time" ;
            time:units = "days since 0000-1-1" ;
    double lat(lat) ;
            lat:units = "degrees_north" ;
            lat:standard_name = "latitude" ;
    double lon(lon) ;
            lon:units = "degrees_east" ;
            lon:standard_name = "longitude" ;
    float tas ;
            tas:standard_name = "air_temperature" ;
            tas:units = "K" ;
            tas:nca_dimensions = "time lat lon" ;
            tas:nca_array = "{directions': {'lat': false,
                                            'time': true,
                                            'lon': true
                                           },
                              'pshape': [2],
                              'pdimensions': ['time'],
                              'Partitions': [{'index': [0],
                                              'data': {'file': '/home/david/test1.nc',
                                                       'shape': [12, 64, 128],
                                                       'ncvar': 'tas'
                                                      },
                                              'location': [[0, 12], [0, 64], [0, 128]],
                                              'format': 'netCDF'
                                             },
                                             {'index': [1],
                                              'data': {'file': '/home/david/test2.nc',
                                                       'shape': [36, 64, 128],
                                                       'ncvar': 'tas2'
                                                      },
                                              'location': [[12, 48], [0, 64], [0, 128]],
                                              'format': 'netCDF'
                                             }
                                            ]
                             }" ;

// global attributes:
               :Conventions = "CF-1.5 NCA" ;
data:

 time = 164569, 164599.5, 164630.5, 164660, 164689.5, 164720, 164750.5,
       // etcetera.

 lat = -87.8638000488281, -85.0965270996094, -82.3129119873047,
       // etcetera.

 lon = 0, 2.8125, 5.625, 8.4375, 11.25, 14.0625, 16.875, 19.6875, 22.5,
       // etcetera.</pre>
</div>
<p>Points to note:</p>
<ul class="simple">
<li>The file specifies two conventions.</li>
<li>The file contains one NCA variable (<tt class="docutils literal"><span class="pre">tas</span></tt>) and three normal
variables (<tt class="docutils literal"><span class="pre">time</span></tt>, <tt class="docutils literal"><span class="pre">lat</span></tt> and <tt class="docutils literal"><span class="pre">lon</span></tt>).</li>
<li>The NCA variable stores the aggregated data array&#8217;s dimensions in a
separate attribute (<tt class="docutils literal"><span class="pre">nca_dimensions</span></tt>) to facilitate
reconstruction of a multidimensional variable without having to decode
the <tt class="docutils literal"><span class="pre">nca_array</span></tt> string.</li>
<li>The <tt class="docutils literal"><span class="pre">nca_array</span></tt> string has been split over many lines for
enhanced readability. Arbitrary new lines are permitted in JSON strings.</li>
<li>The NCA variable defines its data type and units in the normal manner,
so that these parameters of the master array may be omitted from
the <tt class="docutils literal"><span class="pre">nca_array</span></tt> attribute.</li>
<li>The NCA variable may have any CF-netCDF attributes, with no
restrictions.</li>
<li>Parameters of the partitions which are the same as their master array
may be omitted.</li>
</ul>
<hr class="docutils" id="example3" />
<p><strong>Example 3: storing an aggregated data array with an in-memory partition data array</strong>:</p>
<div class="highlight-python"><pre>netcdf temperature2.nca {
dimensions:
        time = 48 ;
        lat = 64 ;
        lon = 128 ;
        nca12 = 12 ;
        nca64 = 64 ;
        nca128 = 128 ;
variable:
        double time(time) ;
                time:long_name = "time" ;
                time:units = "days since 0000-1-1" ;
        double lat(lat) ;
                lat:units = "degrees_north" ;
                lat:standard_name = "latitude" ;
        double lon(lon) ;
                lon:units = "degrees_east" ;
                lon:standard_name = "longitude" ;
        float tas ;
                tas:standard_name = "air_temperature" ;
                tas:units = "K" ;
                tas:nca_dimensions = "time lat lon" ;
                tas:nca_array = "{directions': {'lat': false,
                                                'time': true,
                                                'lon': true
                                               },
                                  'pshape': [2],
                                  'pdimensions': ['time'],
                                  'Partitions': [{'index': [0],
                                                  'units' : 'K @ 273.15',
                                                  'dimensions': ['lon', 'time', lat'],
                                                  'directions': {'time': false},
                                                  'data': {'shape': [128, 12, 64],
                                                           'ncvar': 'nca_45sdf83745'
                                                          },
                                                  'location': [[0, 12], [0, 64], [0, 128]],
                                                  'format': 'netCDF'
                                                 },
                                                 {'index': [1],
                                                  'data': {'file': '/home/david/test2.nc',
                                                           'shape': [36, 64, 128],
                                                           'ncvar': 'tas2'
                                                          },
                                                  'location': [[12, 48], [0, 64], [0, 128]],
                                                  'format': 'netCDF'
                                                 }
                                                ]
                                 }" ;
        float nca_45sdf83745(nca128, nca12, nca64) ;
                nca_45sdf83745:nca_private = 1 ;


// global attributes:
                :Conventions = "CF-1.5 NCA" ;
data:

 time = 164569, 164599.5, 164630.5, 164660, 164689.5, 164720, 164750.5,
       // etcetera.

 lat = -87.8638000488281, -85.0965270996094, -82.3129119873047,
       // etcetera.

 lon = 0, 2.8125, 5.625, 8.4375, 11.25, 14.0625, 16.875, 19.6875, 22.5,
       // etcetera.

 nca_45sdf83745 = -4.5, 3.5, 23.6, -4.45, 13.5, 13.6,
       // etcetera.</pre>
</div>
<p>Points to note:</p>
<ul class="simple">
<li>The in-memory partition data array has been written to the file with an
automatically generated variable name (<tt class="docutils literal"><span class="pre">nca_45sdf83745</span></tt>), which has an
attribute <tt class="docutils literal"><span class="pre">nca_private</span></tt> to mark it as a private variable according to
the NCA convention.</li>
<li>The in-memory array had different units and dimension order relative to the
master array.</li>
<li>The time dimension of the in-memory array is decreasing, but the other
dimensions run in the same sense as the master array.</li>
<li>The private NCA variable has dimensions which are only used by private NCA
variables.</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="recommended-usage">
<h3>3.2.4. Recommended usage<a class="headerlink" href="#recommended-usage" title="Permalink to this headline">¶</a></h3>
<p>It is recommended, though not necessary to write the following types
of variable as normal (non-NCA) netCDF variables:</p>
<ul class="simple">
<li>1-dimensional coordinates and their bounds (to facilitate
discovery).</li>
<li>Aggregated data arrays with only one partition whose data array
would be written to NCA file as a private NCA variable (to avoid
unnecessary obfuscation).</li>
</ul>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>The shape is required since the shape of a multi-character
string array in memory may be different to the shape of the
array stored in a netCDF file, which may be stored as a
character array with an extra trailing dimension.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>In this case, though, the file name may ommitted, in which
case the name of the NCA file is assumed. See the <a class="reference internal" href="nca_attributes.html#file"><em>file</em></a> attribute.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3. The NCA convention</a><ul>
<li><a class="reference internal" href="#storing-the-aggregated-data-array-parameters-in-a-string">3.1. Storing the aggregated data array parameters in a string</a></li>
<li><a class="reference internal" href="#creating-a-netcdf-variable-for-the-aggregated-data-array">3.2. Creating a netCDF variable for the aggregated data array</a><ul>
<li><a class="reference internal" href="#advantages">3.2.1. Advantages</a></li>
<li><a class="reference internal" href="#disadvantages">3.2.2. Disadvantages</a></li>
<li><a class="reference internal" href="#comparison-with-ncml-aggregation">3.2.3. Comparison with NcML aggregation</a></li>
<li><a class="reference internal" href="#recommended-usage">3.2.4. Recommended usage</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="framework.html"
                        title="previous chapter">2. A conceptual framework for the in-memory storage of aggregated arrays</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="nca_attributes.html"
                        title="next chapter">4. A complete description of netCDF NCA attributes describing the aggregated data</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/nca.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search term.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="nca_attributes.html" title="4. A complete description of netCDF NCA attributes describing the aggregated data"
             >next</a> |</li>
        <li class="right" >
          <a href="framework.html" title="2. A conceptual framework for the in-memory storage of aggregated arrays"
             >previous</a> |</li>
  <li><a href="index.html">CFA</a>
      <select onchange="location = this.options[this.selectedIndex].value;">
  <option value="../0.4/index.html">0.4
  <option value="../0.3/index.html">0.3
  <option value="../0.2.2/index.html">0.2.2
  <option value="../0.2.1/index.html">0.2.1
  <option value="../0.2/index.html"selected>0.2
  <option value="../0.1/index.html">0.1
  </select>
  </li>

  
        <li><a href="index.html"></a> &raquo;</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, David Hassell.
      Last updated on Feb 27, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>