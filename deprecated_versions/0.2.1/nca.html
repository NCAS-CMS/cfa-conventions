<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3. The NCA convention</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="" href="index.html" />
    <link rel="next" title="4. A complete description of netCDF NCA attributes describing a master data array" href="nca_attributes.html" />
    <link rel="prev" title="2. A conceptual framework for the in-memory storage of aggregated arrays" href="framework.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="nca_attributes.html" title="4. A complete description of netCDF NCA attributes describing a master data array"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="framework.html" title="2. A conceptual framework for the in-memory storage of aggregated arrays"
             accesskey="P">previous</a> |</li>
  <li><a href="index.html">CFA</a>
      <select onchange="location = this.options[this.selectedIndex].value;">
  <option value="../0.4/index.html">0.4
  <option value="../0.3/index.html">0.3
  <option value="../0.2.2/index.html">0.2.2
  <option value="../0.2.1/index.html"selected>0.2.1
  <option value="../0.2/index.html">0.2
  <option value="../0.1/index.html">0.1
  </select>
  </li>

  
        <li><a href="index.html"></a> &raquo;</li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="the-nca-convention">
<span id="nca-convention"></span><h1>3. The NCA convention<a class="headerlink" href="#the-nca-convention" title="Permalink to this headline">¶</a></h1>
<p><strong>A proposal for the efficient netCDF file storage of master data
arrays</strong></p>
<div class="section" id="storing-the-master-data-array-parameters-in-a-string">
<h2>3.1. Storing the master data array parameters in a string<a class="headerlink" href="#storing-the-master-data-array-parameters-in-a-string" title="Permalink to this headline">¶</a></h2>
<p>Since the parameters which completely describe a master data array may
each be cast as one a set of particular basic types, then these
parameters may be easily encoded in a <a class="reference external" href="http://www.json.org">JSON (JavaScript Object
Notation)</a> string for simple inclusion in a
netCDF file.</p>
<p>JSON is a lightweight data-interchange format which is easy for humans
to read and write and easy for machines to parse and generate. There
are JSON encoders and decoders for every reasonable language. See the
<a class="reference external" href="http://en.wikipedia.org/wiki/JSON">JSON Wikipedia article</a> for some
good examples of JSON strings.</p>
<p>The basic types recognised by JSON are (with JSON encoded examples):</p>
<ul class="simple">
<li>string (<tt class="docutils literal"><span class="pre">'foo'</span></tt>, <tt class="docutils literal"><span class="pre">''</span></tt>)</li>
<li>number (<tt class="docutils literal"><span class="pre">3.14159</span></tt>, <tt class="docutils literal"><span class="pre">0</span></tt>)</li>
<li>boolean (<tt class="docutils literal"><span class="pre">true</span></tt>, <tt class="docutils literal"><span class="pre">false</span></tt>)</li>
<li>undefined (<tt class="docutils literal"><span class="pre">null</span></tt>)</li>
<li>ordered list of any of the basic types (<tt class="docutils literal"><span class="pre">[1,</span> <span class="pre">'a',</span> <span class="pre">['2,</span> <span class="pre">null,</span> <span class="pre">{'x':</span>
<span class="pre">false}]]</span></tt>)</li>
<li>associative array with strings for keys and any of the basic types
for values (<tt class="docutils literal"><span class="pre">{'x':</span> <span class="pre">[4,</span> <span class="pre">[true,</span> <span class="pre">null]],</span> <span class="pre">'y':</span> <span class="pre">2.71828}</span></tt>)</li>
</ul>
<p>It clear that, with the exception of the partition&#8217;s <a class="reference internal" href="framework.html#frame-sub-array"><em>sub_array</em></a> parameter, each of the values of the parameters
which describe a master data array is one or a combination of these
basic types. For example, the <a class="reference internal" href="framework.html#frame-pmshape"><em>pmshape</em></a> parameter
is a list of numbers.</p>
<p>The same is actually true for the partition&#8217;s <a class="reference internal" href="framework.html#frame-sub-array"><em>sub_array</em></a> parameter, although it is not so immediately
obvious. The issue is that it may be a reference to section of a file
or to a multidimensional array in memory. However, in the latter case
the sub-array must be written to a file in order to be stored, so this
reduces to the former case. A file reference is easily encapsulated by
a collection of the basic types. For example, if the reference is to a
netCDF file variable then all that is required are the filename (a
string), the name of the netCDF variable containing the sub-array (a
string) and its shape (a list of numbers) <a class="footnote-reference" href="#f1" id="id1">[1]</a>.</p>
<p>Thus, for storage purposes, all of the master data array parameters
may encoded in a single JSON string.</p>
<p>See the <a class="reference internal" href="nca_attributes.html#nca-ref"><em>complete description of netCDF NCA attributes</em></a>
for details on how each master data array parameter is encoded.</p>
</div>
<div class="section" id="creating-a-netcdf-variable-for-the-master-data-array">
<span id="scalar-variable"></span><h2>3.2. Creating a netCDF variable for the master data array<a class="headerlink" href="#creating-a-netcdf-variable-for-the-master-data-array" title="Permalink to this headline">¶</a></h2>
<p>A multidimensional master data array may be stored in a <strong>scalar
netCDF variable</strong> with the same <strong>data type</strong> as its master array, one
of whose attributes is the JSON encoded string of the master data
array parameters. When read, this scalar array variable may then be
converted to a multidimensional array variable after the parameters
have been decoded. Note that the datum of this scalar netCDF variable
is ignored and need not be set.</p>
<p id="nca-variable">Such a variable is called an <strong>NCA variable</strong> (netCDF aggregate
variable) and a file storing NCA variables is called an <strong>NCA file</strong>
(netCDF aggregate file) and should include both &#8216;CF&#8217; and &#8216;NCA&#8217; in its
global <tt class="docutils literal"><span class="pre">conventions</span></tt> attribute. An NCA file may contain a mixture of
NCA variables and normal netCDF variables (or even no NCA variables at
all).</p>
<p id="nca-private-variable">For partitions whose <a class="reference internal" href="framework.html#frame-sub-array"><em>sub_array</em></a> parameter
refers to a sub-array in memory, that sub-array is written to the NCA
file itself as an <strong>NCA private variable</strong>. This is a normal netCDF
variable marked as containing the sub-array for a partition of one or
more NCA variables and should not be interpreted otherwise according
to the CF conventions. As this sub-array now exists in a netCDF file,
the relevant NCA variables may refer to this sub-array as for any
netCDF variable, i.e. by specifying the netCDF file name <a class="footnote-reference" href="#f2" id="id2">[2]</a>, the
netCDF variable name and its shape. See <a class="reference internal" href="#example4"><em>example 4</em></a>.</p>
<div class="section" id="advantages">
<h3>3.2.1. Advantages<a class="headerlink" href="#advantages" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Variables within an NCA file may be a mixture of normal,
multidimensional array variables and NCA variables.</li>
<li>Much, if not all, of the discovery metadata in an NCA file is
independent of the master data array convention and so is accessible
to all netCDF readers.</li>
<li>Changes to the elements of the master data array may be easily
stored.</li>
<li>Arbitrary (not necessarily contiguous) subsapces of master data
arrays may be stored (see the <a class="reference internal" href="nca_attributes.html#part"><em>part</em></a> parameter).</li>
<li>An NCA variable may have any attributes attached to it.</li>
<li>NCA encoded parameter strings may be succinct, as there are clear
rules on taking default values for partitions.</li>
</ul>
</div>
<div class="section" id="disadvantages">
<h3>3.2.2. Disadvantages<a class="headerlink" href="#disadvantages" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Software which creates and reads NCA files in their entirety needs
to be able to cope with master data arrays. <a class="reference external" href="http://cfpython.bitbucket.org">cf-python</a> can do this.</li>
</ul>
</div>
<div class="section" id="comparison-with-ncml-aggregation">
<span id="ncml"></span><h3>3.2.3. Comparison with NcML aggregation<a class="headerlink" href="#comparison-with-ncml-aggregation" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.unidata.ucar.edu/software/netcdf/ncml/v2.2/Aggregation.html">NetCDF Markup Language (NcML) aggregation</a>
doesn&#8217;t allow:</p>
<ul class="simple">
<li>Simultaneous aggregation across arbitrarily positioned dimensions.</li>
<li>Aggregation of arbitrary parts of arrays.</li>
<li>Aggregation arrays stored in arbitrary formats (in-memory, netCDF,
PP, <em>etc.</em>).</li>
</ul>
</div>
<div class="section" id="recommended-usage">
<h3>3.2.4. Recommended usage<a class="headerlink" href="#recommended-usage" title="Permalink to this headline">¶</a></h3>
<p>It is recommended, though not necessary to write the following types
of variable as normal (non-NCA) netCDF variables:</p>
<ul class="simple">
<li>1-dimensional coordinates and their bounds (to facilitate
discovery).</li>
<li>Master data arrays with only one partition whose data array would be
written to NCA file as a NCA private variable (to avoid unnecessary
obfuscation).</li>
</ul>
</div>
</div>
<div class="section" id="examples">
<h2>3.3. Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="example-3">
<h3>3.3.1. Example 3<a class="headerlink" href="#example-3" title="Permalink to this headline">¶</a></h3>
<p>A simple NCA file:</p>
<div class="highlight-python"><pre>netcdf temperature.nca {
dimensions:
       time = 48 ;
       lat = 64 ;
       lon = 128 ;
variable:

    double time(time) ;
            time:long_name = "time" ;
            time:units = "days since 0000-1-1" ;
    double lat(lat) ;
            lat:units = "degrees_north" ;
            lat:standard_name = "latitude" ;
    double lon(lon) ;
            lon:units = "degrees_east" ;
            lon:standard_name = "longitude" ;
    float tas ;
            tas:standard_name = "air_temperature" ;
            tas:units = "K" ;
            tas:cf_role = "nca_variable" ;
            tas:nca_dimensions = "time lat lon" ;
            tas:nca_array = "{'directions': {'lat': false,
                                             'time': true,
                                             'lon': true
                                            },
                              'pmshape': [2],
                              'pmdimensions': ['time'],
                              'Partitions': [{'index': [0],
                                              'data': {'file': '/home/david/test1.nc',
                                                       'shape': [12, 64, 128],
                                                       'ncvar': 'tas'
                                                      },
                                              'location': [[0, 12], [0, 64], [0, 128]],
                                              'format': 'netCDF'
                                             },
                                             {'index': [1],
                                              'data': {'file': '/home/david/test2.nc',
                                                       'shape': [36, 64, 128],
                                                       'ncvar': 'tas2'
                                                      },
                                              'location': [[12, 48], [0, 64], [0, 128]],
                                              'format': 'netCDF'
                                             }
                                            ]
                             }" ;

// global attributes:
               :Conventions = "CF-1.5 NCA" ;
data:

 time = 164569, 164599.5, 164630.5, 164660, 164689.5, 164720, 164750.5,
       // etcetera.

 lat = -87.8638000488281, -85.0965270996094, -82.3129119873047,
       // etcetera.

 lon = 0, 2.8125, 5.625, 8.4375, 11.25, 14.0625, 16.875, 19.6875, 22.5,
       // etcetera.</pre>
</div>
<p>Points to note:</p>
<ul class="simple">
<li>The file specifies two conventions.</li>
<li>The file contains one NCA variable (<tt class="docutils literal"><span class="pre">tas</span></tt>) and three normal
variables (<tt class="docutils literal"><span class="pre">time</span></tt>, <tt class="docutils literal"><span class="pre">lat</span></tt> and <tt class="docutils literal"><span class="pre">lon</span></tt>).</li>
<li>The NCA variable stores the master data array&#8217;s dimensions in a
separate attribute (<tt class="docutils literal"><span class="pre">nca_dimensions</span></tt>) to facilitate reconstruction
of a multidimensional variable without having to decode the
<tt class="docutils literal"><span class="pre">nca_array</span></tt> string.</li>
<li>The <tt class="docutils literal"><span class="pre">nca_array</span></tt> string has been split over many lines for enhanced
readability. Arbitrary new lines are permitted in JSON strings.</li>
<li>The NCA variable defines its data type and units in the normal
manner, so that these parameters of the master array may be omitted
from the <tt class="docutils literal"><span class="pre">nca_array</span></tt> attribute.</li>
<li>The NCA variable may have any CF-netCDF attributes, with no
restrictions.</li>
<li>Partition parameters which are the same as their master array may be
omitted.</li>
</ul>
</div>
<div class="section" id="example-4">
<span id="example4"></span><h3>3.3.2. Example 4<a class="headerlink" href="#example-4" title="Permalink to this headline">¶</a></h3>
<p>Storing a master data array with an in-memory partition data array:</p>
<div class="highlight-python"><pre>netcdf temperature2.nca {
dimensions:
        time = 48 ;
        lat = 64 ;
        lon = 128 ;
        nca12 = 12 ;
        nca64 = 64 ;
        nca128 = 128 ;
variable:
        double time(time) ;
                time:long_name = "time" ;
                time:units = "days since 0000-1-1" ;
        double lat(lat) ;
                lat:units = "degrees_north" ;
                lat:standard_name = "latitude" ;
        double lon(lon) ;
                lon:units = "degrees_east" ;
                lon:standard_name = "longitude" ;
        float tas ;
                tas:standard_name = "air_temperature" ;
                tas:units = "K" ;
                tas:cf_role = "nca_variable" ;
                tas:nca_dimensions = "time lat lon" ;
                tas:nca_array = "{directions': {'lat': false,
                                                'time': true,
                                                'lon': true
                                               },
                                  'pmshape': [2],
                                  'pmdimensions': ['time'],
                                  'Partitions': [{'index': [0],
                                                  'units' : 'K @ 273.15',
                                                  'dimensions': ['lon', 'time', lat'],
                                                  'directions': {'time': false},
                                                  'data': {'shape': [128, 12, 64],
                                                           'ncvar': 'nca_45sdf83745'
                                                          },
                                                  'location': [[0, 12], [0, 64], [0, 128]],
                                                  'format': 'netCDF'
                                                 },
                                                 {'index': [1],
                                                  'data': {'file': '/home/david/test2.nc',
                                                           'shape': [36, 64, 128],
                                                           'ncvar': 'tas2'
                                                          },
                                                  'location': [[12, 48], [0, 64], [0, 128]],
                                                  'format': 'netCDF'
                                                 }
                                                ]
                                 }" ;
        float nca_45sdf83745(nca128, nca12, nca64) ;
                nca_45sdf83745:cf_role = "nca_private" ;


// global attributes:
                :Conventions = "CF-1.5 NCA" ;
data:

 time = 164569, 164599.5, 164630.5, 164660, 164689.5, 164720, 164750.5,
       // etcetera.

 lat = -87.8638000488281, -85.0965270996094, -82.3129119873047,
       // etcetera.

 lon = 0, 2.8125, 5.625, 8.4375, 11.25, 14.0625, 16.875, 19.6875, 22.5,
       // etcetera.

 nca_45sdf83745 = -4.5, 3.5, 23.6, -4.45, 13.5, 13.6,
       // etcetera.</pre>
</div>
<p>Points to note:</p>
<ul class="simple">
<li>The in-memory partition data array has been written to the file with
an automatically generated variable name (<tt class="docutils literal"><span class="pre">nca_45sdf83745</span></tt>), which
has an attribute <tt class="docutils literal"><span class="pre">nca_private</span></tt> to mark it as a private variable
according to the NCA convention.</li>
<li>The in-memory array had different units and dimension order relative
to the master array.</li>
<li>The time dimension of the in-memory array is decreasing, but the
other dimensions run in the same sense as the master array.</li>
<li>The NCA private variable has dimensions which are only used by it
and other NCA private variables.</li>
</ul>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>The shape is required since the shape of a multi-character
string array in memory may be different to the shape of the
array stored in a netCDF file, which may be stored as a
character array with an extra trailing dimension.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>In this case, though, the file name may be omitted, in which
case the name of the NCA file is assumed. See the <a class="reference internal" href="nca_attributes.html#file"><em>file</em></a> attribute.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3. The NCA convention</a><ul>
<li><a class="reference internal" href="#storing-the-master-data-array-parameters-in-a-string">3.1. Storing the master data array parameters in a string</a></li>
<li><a class="reference internal" href="#creating-a-netcdf-variable-for-the-master-data-array">3.2. Creating a netCDF variable for the master data array</a><ul>
<li><a class="reference internal" href="#advantages">3.2.1. Advantages</a></li>
<li><a class="reference internal" href="#disadvantages">3.2.2. Disadvantages</a></li>
<li><a class="reference internal" href="#comparison-with-ncml-aggregation">3.2.3. Comparison with NcML aggregation</a></li>
<li><a class="reference internal" href="#recommended-usage">3.2.4. Recommended usage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples">3.3. Examples</a><ul>
<li><a class="reference internal" href="#example-3">3.3.1. Example 3</a></li>
<li><a class="reference internal" href="#example-4">3.3.2. Example 4</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="framework.html"
                        title="previous chapter">2. A conceptual framework for the in-memory storage of aggregated arrays</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="nca_attributes.html"
                        title="next chapter">4. A complete description of netCDF NCA attributes describing a master data array</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/nca.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search term.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="nca_attributes.html" title="4. A complete description of netCDF NCA attributes describing a master data array"
             >next</a> |</li>
        <li class="right" >
          <a href="framework.html" title="2. A conceptual framework for the in-memory storage of aggregated arrays"
             >previous</a> |</li>
  <li><a href="index.html">CFA</a>
      <select onchange="location = this.options[this.selectedIndex].value;">
  <option value="../0.4/index.html">0.4
  <option value="../0.3/index.html">0.3
  <option value="../0.2.2/index.html">0.2.2
  <option value="../0.2.1/index.html"selected>0.2.1
  <option value="../0.2/index.html">0.2
  <option value="../0.1/index.html">0.1
  </select>
  </li>

  
        <li><a href="index.html"></a> &raquo;</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, David Hassell.
      Last updated on Feb 27, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>